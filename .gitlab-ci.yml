---
default:
  image: mcr.microsoft.com/devcontainers/python:1-3.12-bookworm

stages:
  - build
  - test
  - deploy

include:
  - template: Jobs/Code-Quality.gitlab-ci.yml

build-python-package:
  stage: build
  before_script:
    - pipenv install --system --dev
    - pip install packaging
  script:
    - echo "Building the project..."
    - python -m build --wheel
  artifacts:
    paths:
      - dist
    expire_in: 1 week

build-documentation:
  stage: build
  before_script:
    - pip install -e .
  script:
    - cd docs && pipenv run make html

code_quality:
  when: manual

test-python-package:
  stage: test
  before_script:
    - pipenv install --system --dev
    - pip install -e .
  script:
    - echo "Running unit tests"
    - pytest
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

deploy-python-package:
  stage: deploy
  before_script:
    - pip install build twine
  script:
    - echo "Deploying the package..."
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
